name: Fetch Manuscripts and Extract Fields

on:
  pull_request:

jobs:
  parse-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch manuscript filenames
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq '.[] | select(.filename | endswith(".manuscript")) | .filename' \
            > manuscript.txt || echo ""

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscript.txt || echo "No manuscripts found."

      # Step 2: Print content and extract name & category
      - name: Extract name and category
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          while IFS= read -r file; do
            [ -z "$file" ] && continue

            echo "=== Processing $file ==="

            # Get patch for this file and strip leading '+'
            content=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
              --jq ".[] | select(.filename==\"$file\") | .patch" \
              | sed 's/^+//')

            # echo "Full content:"
            # echo "$content"
            # echo ""

            # Extract category (single or double quotes)
            category=$(echo "$content" | grep -E "category[ ]*=>[ ]*['\"].*['\"]" | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/")

            # Extract name (single or double quotes)
            name=$(echo "$content" | grep -E "name[ ]*=>[ ]*['\"].*['\"]" | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/")

            echo "Extracted fields:"
            echo "Name: $name"
            echo "Category: $category"
            echo "=============================="
            echo ""
          done < manuscript.txt
