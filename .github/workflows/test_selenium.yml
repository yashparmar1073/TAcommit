name: Fetch Manuscripts

on:
  pull_request:

jobs:
  parse-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch .manuscript files
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '.[] 
              | select(.filename | endswith(".manuscript")) 
              | .filename' \
            > manuscript.txt

      - name: Show manuscript filenames
        run: cat manuscript.txt

      # Step 4: Extract name and category using Python
      - name: Extract name and category
        run: |
          python3 - << 'EOF'
          import re
          import base64
          import subprocess

          # Read manuscript filenames
          with open("manuscript.txt") as f:
              files = [line.strip() for line in f if line.strip()]

          for file in files:
              print(f"Processing: {file}")
              
              # Fetch file content from PR
              result = subprocess.run([
                  "gh", "api",
                  f"repos/${{ github.repository }}/contents/{file}",
                  "--field", f"ref=refs/pull/${{ github.event.pull_request.number }}/head",
                  "--jq", ".content"
              ], capture_output=True, text=True)
              
              content_b64 = result.stdout.strip()
              if not content_b64:
                  print("  Could not fetch content")
                  continue

              content = base64.b64decode(content_b64).decode("utf-8")

              # Extract name and category
              name_match = re.search(r"name\s*=>\s*['\"]([^'\"]+)['\"]", content)
              category_match = re.search(r"category\s*=>\s*['\"]\s*([^'\"]*?)\s*['\"]", content)

              name = name_match.group(1).strip() if name_match else "N/A"
              category = category_match.group(1).strip() if category_match else "N/A"

              print(f"  Name: {name}")
              print(f"  Category: {category}")
          EOF
      
            echo "Name: $name"
            echo "Category: $category"
            echo ""
          done < manuscript.txt
