name: Fetch Manuscripts and Send to Heimdall

on:
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'Pull Request Number (leave empty if running on current branch)'
        required: true
        type: string

jobs:
  process-manuscripts:
    runs-on: ubuntu-latest
  # process-manuscripts:
  #   runs-on:  ta-testcases
  #   container:
  #          image: artifactory.dc.pa.sophos:6555/sfos-dev-docker/sfos-ubuntu:24-04-1.0.12

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch manuscript filenames
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Determine PR number or use current branch
          if [ -n "${{ inputs.pull_request_number }}" ]; then
            PR_NUMBER="${{ inputs.pull_request_number }}"
            echo "Using PR number: $PR_NUMBER"
            gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
              --jq '.[] | select(.filename | endswith(".manuscript")) | .filename' \
              > manuscript.txt || echo ""
          else
            echo "No PR number provided, searching for manuscripts in current branch..."
            echo "Searching in branch: ${{ github.ref_name }}"
            find . -name "*.manuscript" -type f > manuscript.txt || echo ""
          fi

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscript.txt || echo "No manuscripts found."

      # Step 2: Process each manuscript and send data
      - name: Extract fields and send to Heimdall
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Define team mapping
          declare -A team_data=(
            ["Administration"]="Base"
            ["Authentication"]="Kuvempu"
            ["Azure"]="Verdi"
            ["BackupRestore"]="Base"
            ["Base"]="Base"
            ["BaseSystem"]="Base"
            ["CAA_SSLTLS_Scan_Test"]="Kuvempu"
            ["CentralManagement"]="CM"
            ["Certificate"]="Base"
            ["ComponentTestSuite"]="Base"
            ["DateTime"]="Base"
            ["DHCP"]="Bhaskar"
            ["Diagnostics"]="Base"
            ["DNS"]="Base"
            ["Fastpath"]="Gulzar"
            ["FIPS"]="FIPS"
            ["Firewall"]="Gulzar"
            ["Garner"]="Kuvempu"
            ["HA"]="Kabir"
            ["HCL"]="Base"
            ["Heartbeat"]="SyncSec"
            ["HotFix"]="QM"
            ["HTTP-Proxy"]="Web"
            ["Import Export"]="Base"
            ["Infrastructure"]="BLR"
            ["Installation"]="Base"
            ["IPS"]="IPS"
            ["IPsec"]="Krishna"
            ["Licensing"]="Base"
            ["LiveConnection"]="Kuvempu"
            ["Logging"]="Kuvempu"
            ["LogViewer"]="WAF"
            ["Migration"]="Base"
            ["Multilink"]="Kabir"
            ["Network"]="Kabir"
            ["OTP"]="Kuvempu"
            ["Perfomance"]="Perfomance"
            ["POP3-Proxy"]="Nest"
            ["PQA"]="QM"
            ["QM"]="QM"
            ["RED"]="Vivaldi"
            ["RED_legacy"]="Vivaldi"
            ["RemoteAccessVPN"]="RAVPN"
            ["Reporting"]="iView"
            ["SDWAN"]="Bhaskar"
            ["Security"]="Kabir"
            ["SecurityPolicy"]="Gulzar"
            ["SEP"]=""
            ["SEP-CSC-Hybrid"]="Picasso"
            ["SF_CFR Compatability"]="CM"
            ["SMTP-Proxy"]="Nest"
            ["SNMP"]="Karanth"
            ["SophosConnectPolicy"]="RAVPN"
            ["SQL_Injection_UI"]="Framework_UI"
            ["SSLVPN"]="Krishna"
            ["SupportAccess"]="Base"
            ["SystemGraph"]="Kabir"
            ["TA-Framework"]="TA-Framework"
            ["Up2Date"]="Base"
            ["VPN"]="Base"
            ["WAF"]="WAF"
            ["Warhol"]="Warhol"
            ["WebInSnort"]="Web"
            ["WiFi"]="Vivaldi"
            ["Wizard"]="Base"
            ["Zone"]="Verdi"
            ["ZTNA"]="ZTNA"
           )

          # Endpoint URL
          url="https://core.heimdall.c03.pit.els.sophos/results/testcase_mgmt.php?nav=Testcases&subnav=Management"

          PR_NUMBER="${{ inputs.pull_request_number }}"

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            echo "=== Processing $file ==="

            # Fetch file content based on whether PR number is provided
            if [ -n "$PR_NUMBER" ]; then
              # Fetch file patch from PR and remove leading '+'
              content=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
                --jq ".[] | select(.filename==\"$file\") | .patch" \
                | sed 's/^+//')
            else
              # Read file directly from current branch
              content=$(cat "$file" 2>/dev/null || echo "")
            fi

            if [ -z "$content" ]; then
              echo "Warning: Could not fetch content for $file, skipping..."
              continue
            fi

            # Extract category (trim spaces) and name (keep spaces)
            category=$(echo "$content" | grep -E "category[ ]*=>[ ]*['\"].*['\"]" \
                      | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/" | xargs)
            name=$(echo "$content" | grep -E "name[ ]*=>[ ]*['\"].*['\"]" \
                   | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/")

            # Map team
            team="${team_data[$category]}"
            team="${team:-Unknown}"

            echo "Name: $name"
            echo "Category: $category"
            echo "Team: $team"

            # Minimal headers POST with verbose output
            response=$(curl -v -s -X POST "$url" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "id=" \
              
              -d "product=COP" \
              -d "product_add=" \
              -d "category=$category" \
              -d "category_add=" \
              -d "testcase=$name" \
              -d "team=$team" \
              -d "effort=0" \
              -d "notes=" \
              -d "OK=OK") || echo "Curl failed for $file"

            echo "Server Response: $response"
            echo "=============================="
            echo ""
          done < manuscript.txt

