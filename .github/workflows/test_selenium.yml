name: Fetch Manuscript Contents

on:
  pull_request:

jobs:
  fetch-manuscripts:
    runs-on: ubuntu-latest

    steps:
      # Step 0: Checkout repository (needed for GH CLI)
      - uses: actions/checkout@v4

      # Step 1: Fetch manuscript filenames
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq -r '.[] | select(.filename | endswith(".manuscript")) | .filename' \
            > manuscripts.txt || echo ""

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscripts.txt || echo "No manuscripts found."

      # Step 2: Fetch content from raw_url
      - name: Print manuscript contents
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          while IFS= read -r file; do
            [ -z "$file" ] && continue

            echo "=== Content of $file ==="

            # Get raw_url safely
            raw_url=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
              --jq -r ".[] | select(.filename==\"$file\") | .raw_url")

            if [ -z "$raw_url" ]; then
              echo "Could not fetch raw_url for $file"
              continue
            fi

            # Fetch content
            curl -s -H "Authorization: token $GH_TOKEN" "$raw_url"

            echo ""
            echo "=============================="
            echo ""
          done < manuscripts.txt
