name: Fetch Manuscripts and Send to Heimdall

on:
  pull_request:

jobs:
  process-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch manuscript filenames
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq '.[] | select(.filename | endswith(".manuscript")) | .filename' \
            > manuscript.txt || echo ""

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscript.txt || echo "No manuscripts found."

      # Step 2: Process each manuscript and send data
      - name: Extract fields and send to Heimdall
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Define team mapping
          declare -A team_data=(
            ["Administration"]="Base"
            ["Authentication"]="Kuvempu"
            ["Azure"]="Verdi"
            ["BackupRestore"]="Base"
            ["Base"]="Base"
            ["BaseSystem"]="Base"
            ["CAA_SSLTLS_Scan_Test"]="Kuvempu"
            ["CentralManagement"]="CM"
            ["Certificate"]="Base"
            ["ComponentTestSuite"]="Base"
            ["DateTime"]="Base"
            ["DHCP"]="Bhaskar"
            ["Diagnostics"]="Base"
            ["DNS"]="Base"
            ["Fastpath"]="Gulzar"
            ["FIPS"]="FIPS"
            ["Firewall"]="Gulzar"
            ["Garner"]="Kuvempu"
            ["HA"]="Kabir"
            ["HCL"]="Base"
            ["Heartbeat"]="SyncSec"
            ["HotFix"]="QM"
            ["HTTP-Proxy"]="Web"
            ["Import Export"]="Base"
            ["Infrastructure"]="BLR"
            ["Installation"]="Base"
            ["IPS"]="IPS"
            ["IPsec"]="Krishna"
            ["Licensing"]="Base"
            ["LiveConnection"]="Kuvempu"
            ["Logging"]="Kuvempu"
            ["LogViewer"]="WAF"
            ["Migration"]="Base"
            ["Multilink"]="Kabir"
            ["Network"]="Kabir"
            ["OTP"]="Kuvempu"
            ["Perfomance"]="Perfomance"
            ["POP3-Proxy"]="Nest"
            ["PQA"]="QM"
            ["QM"]="QM"
            ["RED"]="Vivaldi"
            ["RED_legacy"]="Vivaldi"
            ["RemoteAccessVPN"]="RAVPN"
            ["Reporting"]="iView"
            ["SDWAN"]="Bhaskar"
            ["Security"]="Kabir"
            ["SecurityPolicy"]="Gulzar"
            ["SEP"]=""
            ["SEP-CSC-Hybrid"]="Picasso"
            ["SF_CFR Compatability"]="CM"
            ["SMTP-Proxy"]="Nest"
            ["SNMP"]="Karanth"
            ["SophosConnectPolicy"]="RAVPN"
            ["SQL_Injection_UI"]="Framework_UI"
            ["SSLVPN"]="Krishna"
            ["SupportAccess"]="Base"
            ["SystemGraph"]="Kabir"
            ["TA-Framework"]="TA-Framework"
            ["Up2Date"]="Base"
            ["VPN"]="Base"
            ["WAF"]="WAF"
            ["Warhol"]="Warhol"
            ["WebInSnort"]="Web"
            ["WiFi"]="Vivaldi"
            ["Wizard"]="Base"
            ["Zone"]="Verdi"
            ["ZTNA"]="ZTNA"
          )

          url="https://core.heimdall.c03.pit.els.sophos/results/testcase_mgmt.php?nav=Testcases&subnav=Management"

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            echo "=== Processing $file ==="

            # Fetch file patch and strip leading '+'
            content=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
              --jq ".[] | select(.filename==\"$file\") | .patch" \
              | sed 's/^+//')

            # Extract category and trim spaces (single or double quotes)
            category=$(echo "$content" | grep -E "category[ ]*=>[ ]*['\"].*['\"]" \
                      | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/" | xargs)

            # Extract name (single or double quotes), keep spaces intact
            name=$(echo "$content" | grep -E "name[ ]*=>[ ]*['\"].*['\"]" \
                   | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/")

            # Map team from category
            team="${team_data[$category]}"
            if [ -z "$team" ]; then
              team="Unknown"
            fi

            echo "Name: $name"
            echo "Category: $category"
            echo "Team: $team"

            # Send POST request
            response=$(curl -s -X POST "$url" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8" \
              -H "Accept-Language: en-US,en;q=0.5" \
              -H "Accept-Encoding: gzip, deflate, br, zstd" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -H "Origin: https://core.heimdall.c03.pit.els.sophos" \
              -H "Connection: keep-alive" \
              -H "Referer: $url" \
              -H "Upgrade-Insecure-Requests: 1" \
              -H "Sec-Fetch-Dest: document" \
              -H "Sec-Fetch-Mode: navigate" \
              -H "Sec-Fetch-Site: same-origin" \
              -H "Sec-Fetch-User: ?1" \
              -H "Priority: u=0, i" \
              -d "id=" \
              -d "product=COP" \
              -d "product_add=" \
              -d "category=$category" \
              -d "category_add=" \
              -d "testcase=$name" \
              -d "team=$team" \
              -d "effort=0" \
              -d "notes=" \
              -d "OK=OK")

            echo "Server Response: $response"
            echo "=============================="
            echo ""

          done < manuscript.txt
