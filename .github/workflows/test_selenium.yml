name: Fetch Manuscripts

on:
  pull_request:

jobs:
  parse-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch .manuscript files
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '.[] 
              | select(.filename | endswith(".manuscript")) 
              | .filename' \
            > manuscript.txt

      - name: Show manuscript filenames
        run: cat manuscript.txt

      # Step 2: Fetch content of each manuscript & extract fields
      - name: Fetch manuscript content and extract fields
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          while read file; do
            echo "=== Processing $file ==="
      
            # Get raw_url for the file in PR
            raw_url=$(gh api \
              repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
              --jq ".[] | select(.filename==\"$file\") | .raw_url")
      
            # Fetch content from raw_url
            content=$(curl -H "Authorization: token $GH_TOKEN" -s "$raw_url")
      
            echo "$content" > temp.manuscript
      
            # Extract name and category (handles single or double quotes)
            # Extract name (handles single or double quotes, optional spaces, optional trailing comma)
            name=$(grep -E '^\s*name\s*=>' temp.manuscript | sed -E "s/^\s*name\s*=>\s*['\"]([^'\"]*)['\"].*/\1/")
            
            # Extract category (also trim leading/trailing spaces inside the quotes)
            category=$(grep -E '^\s*category\s*=>' temp.manuscript | sed -E "s/^\s*category\s*=>\s*['\"]\s*([^'\"]*?)\s*['\"].*/\1/")


      
            echo "Name: $name"
            echo "Category: $category"
            echo ""
          done < manuscript.txt
