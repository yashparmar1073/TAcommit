name: Fetch Manuscripts

on:
  pull_request:

jobs:
  parse-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch .manuscript files
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '.[] 
              | select(.filename | endswith(".manuscript")) 
              | .filename' \
            > manuscript.txt

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscript.txt || echo "No manuscripts found."

      # Step 2: Fetch content & extract name and category
      - name: Extract name and category from manuscripts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          while read file; do
            echo "=== Processing $file ==="

            # Get raw_url for the manuscript file
            raw_url=$(gh api \
              repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
              --jq ".[] | select(.filename==\"$file\") | .raw_url")

            # Fetch file content
            curl -H "Authorization: token $GH_TOKEN" -s "$raw_url" > temp.manuscript

            # Extract name and category safely using Python
            python3 - <<EOF
            import re
            
            with open("temp.manuscript") as f:
                data = f.read()
            
            # Regex to handle both single and double quotes
            name_match = re.search(r'name\s*=>\s*["\']([^"\']+)["\']', data)
            category_match = re.search(r'category\s*=>\s*["\']([^"\']+)["\']', data)
            
            name = name_match.group(1) if name_match else "<missing>"
            category = category_match.group(1) if category_match else "<missing>"
            
            print(f"Name: {name}")
            print(f"Category: {category}")
            EOF 
            
            echo ""
          done < manuscript.txt
