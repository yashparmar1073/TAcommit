name: Fetch Manuscripts and Send to Heimdall

on:
  pull_request:

jobs:
  process-manuscripts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: Fetch manuscript filenames
      - name: Fetch manuscript filenames
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq '.[] | select(.filename | endswith(".manuscript")) | .filename' \
            > manuscript.txt || echo ""

      - name: Show manuscript filenames
        run: |
          echo "Manuscript files found:"
          cat manuscript.txt || echo "No manuscripts found."

      # Step 2: Process each manuscript and send data
      - name: Extract fields and send to Heimdall
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Define team mapping
          declare -A team_data=(
            ["RED"]="Vivaldi"
            ["DHCP"]="Bhaskar"
            ["Fastpath"]="Gulzar"
            # Add remaining mappings here...
          )

          # Endpoint URL
          url="https://core.heimdall.c03.pit.els.sophos/results/testcase_mgmt.php?nav=Testcases&subnav=Management"

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            echo "=== Processing $file ==="

            # Fetch file patch and remove leading '+'
            content=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
              --jq ".[] | select(.filename==\"$file\") | .patch" \
              | sed 's/^+//')

            # Extract category (trim spaces) and name (keep spaces)
            category=$(echo "$content" | grep -E "category[ ]*=>[ ]*['\"].*['\"]" \
                      | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/" | xargs)
            name=$(echo "$content" | grep -E "name[ ]*=>[ ]*['\"].*['\"]" \
                   | sed -E "s/.*=>[ ]*['\"]([^'\"]+)['\"].*/\1/")

            # Map team
            team="${team_data[$category]}"
            team="${team:-Unknown}"

            echo "Name: $name"
            echo "Category: $category"
            echo "Team: $team"

            # Minimal headers POST with verbose output
            response=$(curl -v -s -X POST "$url" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "id=" \
              -d "product=COP" \
              -d "product_add=" \
              -d "category=$category" \
              -d "category_add=" \
              -d "testcase=$name" \
              -d "team=$team" \
              -d "effort=0" \
              -d "notes=" \
              -d "OK=OK") || echo "Curl failed for $file"

            echo "Server Response: $response"
            echo "=============================="
            echo ""
          done < manuscript.txt
